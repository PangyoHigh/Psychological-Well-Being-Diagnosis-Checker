interface DataRange {
  [key: string]: string;
}

const calculateTScore = (
  data: DataRange,
  score: number
): number | undefined => {
  for (const key in data) {
    const [min, max] = key.split("-").map(Number);
    const [start, end] = data[key].split("-").map(Number);

    if (score >= min && score <= max) {
      if (min === max || start === end) {
        return start;
      }
      const ratio = (score - min) / (max - min);
      const tScore = start + ratio * (end - start);
      return Math.round(tScore);
    }
  }
  return null;
};

const scoreData: { [key: string]: DataRange } = {
  종합점수: {
    boy: {
      "0-2": "35-39",
      "3-7": "40-44",
      "8-13": "45-49",
      "14-19": "50-54",
      "20-25": "55-59",
      "26-31": "60-64",
      "32-37": "65-69",
      "38-42": "70-74",
      "43-48": "75-79",
      "49-54": "80-84",
      "55-60": "85-89",
      "61-66": "90-94",
      "67-108": "95-100",
    },
    girl: {
      "0-2": "35-39",
      "3-9": "40-44",
      "10-15": "45-49",
      "16-21": "50-54",
      "22-28": "55-59",
      "29-34": "60-64",
      "35-41": "65-69",
      "42-47": "70-74",
      "48-53": "75-79",
      "54-60": "80-84",
      "61-66": "85-89",
      "67-73": "90-94",
      "74-108": "95-100",
    },
  },
  "불안 및 우울 문제": {
    boy: {
      "0-1": "35-39",
      "2-3": "40-44",
      "4-6": "45-49",
      "7-8": "50-54",
      "9-11": "55-59",
      "12-13": "60-64",
      "14-16": "65-69",
      "17-18": "70-74",
      "19-21": "75-79",
      "22-23": "80-84",
      "24-24": "85-89",
    },
    girl: {
      "0-2": "35-39",
      "3-4": "40-44",
      "5-7": "45-49",
      "8-10": "50-54",
      "11-12": "55-59",
      "13-15": "60-64",
      "16-17": "65-69",
      "18-20": "70-74",
      "21-23": "75-79",
      "24-24": "80-84",
    },
  },
  "자살 및 위기 문제": {
    boy: {
      "0-0": "45-49",
      "1-2": "50-54",
      "3-3": "55-59",
      "4-4": "60-64",
      "5-5": "65-69",
      "6-6": "70-74",
      "7-7": "75-79",
      "8-8": "80-84",
      "9-9": "85-89",
      "10-10": "90-94",
      "11-18": "95-100",
    },
    girl: {
      "0-0": "35-39",
      "1-1": "45-49",
      "2-2": "50-54",
      "3-4": "55-59",
      "5-5": "60-64",
      "6-7": "65-69",
      "8-8": "70-74",
      "9-10": "75-79",
      "11-11": "80-84",
      "12-13": "85-89",
      "14-14": "90-94",
      "15-18": "95-100",
    },
  },
  "외현화 문제": {
    boy: {
      "0-0": "40-44",
      "1-2": "45-49",
      "3-3": "50-54",
      "4-4": "55-59",
      "5-6": "60-64",
      "7-7": "65-69",
      "8-8": "70-74",
      "9-9": "75-79",
      "10-11": "80-84",
      "12-12": "85-89",
      "13-13": "90-94",
      "14-24": "95-100",
    },
    girl: {
      "0-0": "40-44",
      "1-1": "45-49",
      "2-2": "50-54",
      "3-3": "55-59",
      "4-4": "60-64",
      "5-5": "65-69",
      "6-6": "70-74",
      "7-7": "75-79",
      "8-8": "80-84",
      "9-9": "85-89",
      "10-10": "90-94",
      "11-24": "95-100",
    },
  },
  "심리외상 문제": {
    boy: {
      "0-0": "40-44",
      "1-1": "45-49",
      "2-2": "50-54",
      "3-3": "55-59",
      "4-5": "60-64",
      "6-6": "65-69",
      "7-7": "70-74",
      "8-8": "75-79",
      "9-10": "80-84",
      "11-11": "85-89",
      "12-12": "90-94",
      "13-21": "95-100",
    },
    girl: {
      "0-0": "40-44",
      "1-1": "45-49",
      "2-3": "50-54",
      "4-4": "55-59",
      "5-5": "60-64",
      "6-7": "65-69",
      "8-8": "70-74",
      "9-10": "75-79",
      "11-11": "80-84",
      "12-13": "85-89",
      "14-14": "90-94",
      "15-21": "95-100",
    },
  },
  "학교생활적응 문제": {
    boy: {
      "0-0": "35-39",
      "1-1": "40-44",
      "2-2": "45-49",
      "3-4": "50-54",
      "5-5": "55-59",
      "6-6": "60-64",
      "7-8": "65-69",
      "9-9": "70-74",
      "10-11": "75-79",
      "12-12": "80-84",
      "13-13": "85-89",
      "14-15": "90-94",
      "16-21": "95-100",
    },
    girl: {
      "0-0": "35-39",
      "1-1": "40-44",
      "2-3": "45-49",
      "4-4": "50-54",
      "5-6": "55-59",
      "7-7": "60-64",
      "8-9": "65-69",
      "10-11": "70-74",
      "12-12": "75-79",
      "13-14": "80-84",
      "15-15": "85-89",
      "16-17": "90-94",
      "18-21": "95-100",
    },
  },
};
const approximateMeanSD = (
  min: number,
  max: number,
  tMin: number,
  tMax: number
) => {
  const meanRaw = (min + max) / 2;
  const meanT = (tMin + tMax) / 2;

  const sdRaw = ((max - min) / (tMax - tMin)) * 10; // since 10 is the standard T-score SD

  return { meanRaw, meanT, sdRaw };
};

export default function convertScoreToTScore(
  type: string,
  gender: "boy" | "girl",
  rawScore: number
): number | null {
  const data = scoreData[type]?.[gender];
  if (!data) return null;

  for (const range in data) {
    const [min, max] = range.split("-").map(Number);
    const [tMin, tMax] = data[range].split("-").map(Number);

    if (rawScore >= min && rawScore <= max) {
      if (min === max || tMin === tMax) return tMin;

      const { meanRaw, meanT, sdRaw } = approximateMeanSD(min, max, tMin, tMax);
      const z = (rawScore - meanRaw) / sdRaw;
      const tScore = meanT + z * 10;
      
      return Math.round(tScore);
    }
  }

  return null;
}